<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Mini Heatwave API Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --card: #111827;      /* gray-900 */
      --muted: #94a3b8;     /* slate-400 */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #60a5fa;    /* blue-400 */
      --accent-2: #f59e0b;  /* amber-500 */
      --ok: #22c55e;        /* green-500 */
      --danger: #ef4444;    /* red-500 */
      --border: #1f2937;    /* gray-800 */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; background: linear-gradient(180deg, #0b1226, #0f172a);
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
    }
    h1 { font-size: 24px; margin: 0 0 12px; font-weight: 800; letter-spacing: 0.2px; }
    p  { margin: 0 0 18px; color: var(--muted); }
    .wrap {
      max-width: 1100px; margin: 0 auto; display: grid; gap: 16px;
      grid-template-columns: 1.1fr 2fr;
    }
    .card {
      background: rgba(17, 24, 39, 0.7);
      border: 1px solid var(--border);
      border-radius: 16px; padding: 16px; backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0b1220; color: var(--text); outline: none;
    }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(96,165,250,.25); }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      color: #0b1220; border: none; padding: 10px 14px; border-radius: 12px; cursor: pointer;
      font-weight: 700;
    }
    .btn.secondary {
      background: linear-gradient(135deg, #c084fc, #a855f7); color: #0b1220;
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .kpi { background: #0b1220; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 20px; font-weight: 800; margin-top: 4px; }
    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .badge { padding: 4px 8px; font-size: 12px; border-radius: 999px; background: #0b1220; border: 1px solid var(--border); color: var(--muted); }
    .list { margin-top: 12px; display: grid; gap: 8px; max-height: 280px; overflow: auto; }
    .item { padding: 10px; border: 1px dashed var(--border); border-radius: 10px; }
    .muted { color: var(--muted); }
    .error { color: var(--danger); font-weight: 700; }
    .footer { margin-top: 18px; font-size: 12px; color: var(--muted); }
    @media (max-width: 960px) {
      .wrap { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>ğŸŒ Mini Heatwave API Client</h1>
  <p>ì—°ë„/ì„ê³„ê°’ì„ ì„ íƒí•´ <code>/summary</code>, <code>/top-heat-days</code>ë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ ì¹´ë“œ/ì°¨íŠ¸ë¡œ í™•ì¸í•´ìš”.</p>

  <div class="wrap">
    <!-- ì¢Œì¸¡: í¼/ì»¨íŠ¸ë¡¤ -->
    <div class="card">
      <h2 style="margin-top:0;">ğŸ”§ ìš”ì²­ ì„¤ì •</h2>
      <div class="row">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" type="text" value="" placeholder="(ë¹„ì›Œë‘ë©´ í˜„ì¬ í˜¸ìŠ¤íŠ¸ ê¸°ì¤€)" />
        </div>
        <div>
          <label>ì—°ë„ (ì„ íƒ)</label>
          <select id="yearSelect">
            <option value="">ì „ì²´</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>í­ì—¼ ê¸°ì¤€(Â°C) â€” /summary</label>
          <input id="threshold" type="number" step="0.1" value="33.0" />
        </div>
        <div>
          <label>ìƒìœ„ ì¼ ìˆ˜ K â€” /top-heat-days</label>
          <input id="topk" type="number" min="1" max="31" value="5" />
        </div>
      </div>

      <div class="flex" style="margin-top:14px;">
        <button class="btn" id="btnHealth">/health ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn secondary" id="btnSummary">/summary ì‹¤í–‰</button>
        <button class="btn" id="btnTop">/top-heat-days ì‹¤í–‰</button>
        <span id="status" class="badge">ëŒ€ê¸°</span>
      </div>

      <div id="err" class="error" style="margin-top:10px;"></div>

      <div class="footer">
        CORS ì˜¤ë¥˜ê°€ ë‚˜ë©´ FastAPIì— <code>CORSMiddleware</code> ì¶”ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”.
      </div>
    </div>

    <!-- ìš°ì¸¡: ì¶œë ¥/ì‹œê°í™” -->
    <div class="card">
      <h2 style="margin-top:0;">ğŸ“Š ê²°ê³¼</h2>

      <!-- Summary -->
      <div id="summaryBox" class="kpis" style="display:none;">
        <div class="kpi">
          <div class="label">ì—°ë„</div>
          <div class="value" id="kpiYear">-</div>
        </div>
        <div class="kpi">
          <div class="label">ê´€ì¸¡ì¼ìˆ˜</div>
          <div class="value" id="kpiDays">-</div>
        </div>
        <div class="kpi">
          <div class="label">í­ì—¼ì¼ìˆ˜(â‰¥ T)</div>
          <div class="value" id="kpiHeatDays">-</div>
        </div>
        <div class="kpi">
          <div class="label">í‰ê·  ìµœê³ ê¸°ì˜¨</div>
          <div class="value" id="kpiMean">-</div>
        </div>
        <div class="kpi">
          <div class="label">ìµœëŒ€ ìµœê³ ê¸°ì˜¨</div>
          <div class="value" id="kpiMax">-</div>
        </div>
        <div class="kpi">
          <div class="label">ìµœì†Œ ìµœê³ ê¸°ì˜¨</div>
          <div class="value" id="kpiMin">-</div>
        </div>
      </div>

      <!-- Top-K list -->
      <div id="topList" style="display:none; margin-top:14px;">
        <div class="flex">
          <span class="badge">Top Heat Days</span>
          <span class="muted" id="topMeta"></span>
        </div>
        <div class="list" id="topItems"></div>
      </div>

      <!-- Chart -->
      <div style="margin-top:16px;">
        <canvas id="chart" height="200"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE_EL = document.getElementById('apiBase');
    const YEAR_SEL    = document.getElementById('yearSelect');
    const THRESH_EL   = document.getElementById('threshold');
    const TOPK_EL     = document.getElementById('topk');
    const STATUS_EL   = document.getElementById('status');
    const ERR_EL      = document.getElementById('err');

    const KPI_BOX     = document.getElementById('summaryBox');
    const KPI_YEAR    = document.getElementById('kpiYear');
    const KPI_DAYS    = document.getElementById('kpiDays');
    const KPI_HEAT    = document.getElementById('kpiHeatDays');
    const KPI_MEAN    = document.getElementById('kpiMean');
    const KPI_MAX     = document.getElementById('kpiMax');
    const KPI_MIN     = document.getElementById('kpiMin');

    const TOP_BOX     = document.getElementById('topList');
    const TOP_META    = document.getElementById('topMeta');
    const TOP_ITEMS   = document.getElementById('topItems');

    const BTN_HEALTH  = document.getElementById('btnHealth');
    const BTN_SUMMARY = document.getElementById('btnSummary');
    const BTN_TOP     = document.getElementById('btnTop');

    // Default API base: same origin
    const defaultBase = "http://localhost:8000";
    API_BASE_EL.value = defaultBase;  // input ë°•ìŠ¤ì—ë„ ê¸°ë³¸ í‘œì‹œ

    function apiBase() {
      const v = API_BASE_EL.value.trim();
      return v || defaultBase;
    }

    function q(params) {
      const usp = new URLSearchParams();
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== '') usp.set(k, v);
      });
      const s = usp.toString();
      return s ? `?${s}` : '';
    }

    function setBusy(busy, label = 'ìš”ì²­ ì¤‘') {
      STATUS_EL.textContent = busy ? label : 'ëŒ€ê¸°';
      BTN_HEALTH.disabled = BTN_SUMMARY.disabled = BTN_TOP.disabled = busy;
      ERR_EL.textContent = '';
    }

    function handleError(err) {
      console.error(err);
      ERR_EL.textContent = (err && err.message) ? err.message : 'ìš”ì²­ ì‹¤íŒ¨';
      setBusy(false);
    }

    // ===== Chart.js =====
    let chart;
    function ensureChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      if (chart) return chart;
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'ìµœê³ ê¸°ì˜¨(Â°C)', data: [] }] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { ticks: { color: '#cbd5e1' } },
            y: { ticks: { color: '#cbd5e1' }, beginAtZero: false }
          }
        }
      });
      return chart;
    }

    function renderTopChart(rows) {
      const c = ensureChart();
      const labels = rows.map(r => {
        // r["ì¼ì‹œ"]ê°€ ISO ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
        const d = new Date(r["ì¼ì‹œ"]);
        return isNaN(d.getTime()) ? r["ì¼ì‹œ"] : d.toISOString().substring(0, 10);
      });
      const temps = rows.map(r => r["ìµœê³ ê¸°ì˜¨(Â°C)"]);
      c.data.labels = labels;
      c.data.datasets[0].data = temps;
      c.update();
    }

    function renderSummaryCard(s) {
      KPI_YEAR.textContent = s.year ?? 'ì „ì²´';
      KPI_DAYS.textContent = s.n_days.toLocaleString();
      KPI_HEAT.textContent = `${s.heatwave_days.toLocaleString()} (â‰¥ ${s.threshold_C}Â°C)`;
      KPI_MEAN.textContent = `${s.tmax_mean.toFixed(2)}Â°C`;
      KPI_MAX.textContent  = `${s.tmax_max.toFixed(2)}Â°C`;
      KPI_MIN.textContent  = `${s.tmax_min.toFixed(2)}Â°C`;
      KPI_BOX.style.display = 'grid';
    }

    function renderTopList(year, k, rows) {
      TOP_BOX.style.display = 'block';
      TOP_META.textContent = `ì—°ë„: ${year || 'ì „ì²´'} Â· K=${k}`;
      TOP_ITEMS.innerHTML = '';
      rows.forEach((r, i) => {
        const when = (() => {
          const d = new Date(r["ì¼ì‹œ"]);
          return isNaN(d.getTime()) ? r["ì¼ì‹œ"] : d.toLocaleDateString();
        })();
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div><strong>${i+1}ìœ„</strong> Â· ${when}</div>
            <div><span class="badge">ìµœê³ ê¸°ì˜¨ ${r["ìµœê³ ê¸°ì˜¨(Â°C)"]}Â°C</span></div>
          </div>
          <div class="muted" style="margin-top:6px;">ì—°ë„: ${r["ì—°ë„"]}</div>
        `;
        TOP_ITEMS.appendChild(el);
      });
    }

    // ===== API Calls =====
    async function callHealth() {
      setBusy(true, '/health í˜¸ì¶œ');
      const url = `${apiBase()}/health`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`/health ì‹¤íŒ¨ (${res.status})`);
      const data = await res.json();
      setBusy(false, 'ì™„ë£Œ');
      // ì—°ë„ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
      YEAR_SEL.innerHTML = '<option value="">ì „ì²´</option>';
      (data.years || []).forEach(y => {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        YEAR_SEL.appendChild(opt);
      });
      // ìƒíƒœ ë±ƒì§€
      STATUS_EL.textContent = `OK: ${data.rows} rows, years=${(data.years||[]).join(', ')}`;
    }

    async function callSummary() {
      setBusy(true, '/summary í˜¸ì¶œ');
      const year = YEAR_SEL.value || undefined;
      const threshold = THRESH_EL.value;
      const url = `${apiBase()}/summary${q({ year, threshold })}`;
      const res = await fetch(url);
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(`/summary ì‹¤íŒ¨ (${res.status}) ${msg}`);
      }
      const s = await res.json();
      renderSummaryCard(s);
      setBusy(false, 'ì™„ë£Œ');
    }

    async function callTop() {
      setBusy(true, '/top-heat-days í˜¸ì¶œ');
      const year = YEAR_SEL.value || undefined;
      const k = TOPK_EL.value || 5;
      const url = `${apiBase()}/top-heat-days${q({ year, k })}`;
      const res = await fetch(url);
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(`/top-heat-days ì‹¤íŒ¨ (${res.status}) ${msg}`);
      }
      const t = await res.json();
      const rows = t.data || [];
      renderTopList(t.year, t.k, rows);
      renderTopChart(rows);
      setBusy(false, 'ì™„ë£Œ');
    }

    // ===== Events =====
    BTN_HEALTH.addEventListener('click', () => callHealth().catch(handleError));
    BTN_SUMMARY.addEventListener('click', () => callSummary().catch(handleError));
    BTN_TOP.addEventListener('click', () => callTop().catch(handleError));

    // ì´ˆê¸° ë™ì‘: health í˜¸ì¶œí•´ì„œ ì—°ë„ ëª©ë¡ ì±„ìš°ê¸° ì‹œë„
    callHealth().catch(err => {
      // ì´ˆê¸° ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ë©”ì‹œì§€ë§Œ í‘œì‹œ (ì˜ˆ: ì„œë²„ ë¯¸ì‹¤í–‰)
      ERR_EL.textContent = 'ì´ˆê¸° /health í˜¸ì¶œ ì‹¤íŒ¨: ' + (err.message || err);
    });
  </script>
</body>
</html>
